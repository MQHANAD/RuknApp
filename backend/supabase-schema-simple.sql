-- u0625u0646u0634u0627u0621 u0627u0645u062au062fu0627u062f PostGIS (u0627u062eu062au064au0627u0631u064a - u064au0645u0643u0646 u062du0630u0641u0647 u0625u0630u0627 u0633u0628u0628 u0645u0634u0627u0643u0644)
-- CREATE EXTENSION IF NOT EXISTS postgis;

-- u0625u0646u0634u0627u0621 u062cu062fu0648u0644 u0631u0648u0627u062f u0627u0644u0623u0639u0645u0627u0644
CREATE TABLE entrepreneurs (
  id BIGSERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  city TEXT NOT NULL,
  country TEXT NOT NULL,
  avatar_url TEXT,
  latitude DOUBLE PRECISION,
  longitude DOUBLE PRECISION,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT (now()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT (now())
);

-- u0625u0646u0634u0627u0621 u062cu062fu0648u0644 u0627u0644u0645u0627u0644u0643u064au0646
CREATE TABLE owners (
  id BIGSERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  phone TEXT,
  city TEXT NOT NULL,
  country TEXT NOT NULL,
  avatar_url TEXT,
  latitude DOUBLE PRECISION,
  longitude DOUBLE PRECISION,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT (now()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT (now())
);

-- u0625u0646u0634u0627u0621 u062cu062fu0648u0644 u0627u0644u0645u062du0644u0627u062a
CREATE TABLE shops (
  shop_id BIGSERIAL PRIMARY KEY,
  owner_id BIGINT NOT NULL,
  renter_id BIGINT,
  name TEXT NOT NULL,
  price INTEGER NOT NULL,
  duration_type TEXT NOT NULL CHECK (duration_type IN ('daily', 'weekly', 'monthly', 'yearly')),
  city TEXT NOT NULL,
  country TEXT NOT NULL,
  district TEXT,
  street TEXT,
  area_m2 INTEGER,
  url TEXT,
  latitude DOUBLE PRECISION,
  longitude DOUBLE PRECISION,
  description TEXT,
  age_years INTEGER,
  building_number INTEGER,
  zip_code INTEGER,
  additional_number INTEGER,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT (now()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT (now())
);

-- u0625u0646u0634u0627u0621 u062cu062fu0648u0644 u0627u0644u0635u0648u0631
CREATE TABLE images (
  id BIGSERIAL PRIMARY KEY,
  shop_id BIGINT NOT NULL,
  url TEXT NOT NULL
);

-- u0625u0646u0634u0627u0621 u062cu062fu0648u0644 u0627u0644u0641u064au062fu064au0648u0647u0627u062a
CREATE TABLE videos (
  id BIGSERIAL PRIMARY KEY,
  shop_id BIGINT NOT NULL,
  url TEXT NOT NULL
);

-- u0625u0646u0634u0627u0621 u062cu062fu0648u0644 u0627u0644u0645u064au0632u0627u062a
CREATE TABLE features (
  id BIGSERIAL PRIMARY KEY,
  shop_id BIGINT NOT NULL,
  feature TEXT NOT NULL
);

-- u0625u0646u0634u0627u0621 u062cu062fu0648u0644 u0627u0644u0645u0641u0636u0644u0629
CREATE TABLE favorites (
  entrepreneur_id BIGINT NOT NULL,
  shop_id BIGINT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT (now()),
  PRIMARY KEY (entrepreneur_id, shop_id)
);

-- u0625u0646u0634u0627u0621 u062cu062fu0648u0644 u0627u0644u0645u062du0627u062fu062bu0627u062a
CREATE TABLE chats (
  entrepreneur_id BIGINT NOT NULL,
  owner_id BIGINT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT (now()),
  PRIMARY KEY (entrepreneur_id, owner_id)
);

-- u0625u0646u0634u0627u0621 u062cu062fu0648u0644 u0627u0644u0623u0641u0643u0627u0631
CREATE TABLE ideas (
  id BIGSERIAL PRIMARY KEY,
  entrepreneur_id BIGINT NOT NULL,
  idea_name TEXT NOT NULL,
  description TEXT,
  type TEXT NOT NULL CHECK (type IN ('restaurant', 'retail', 'office', 'service')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT (now())
);

-- u0625u0646u0634u0627u0621 u062cu062fu0648u0644 u062fu0631u062cu0627u062a u0627u0644u0630u0643u0627u0621 u0627u0644u0627u0635u0637u0646u0627u0639u064a
CREATE TABLE ai_scores (
  id BIGSERIAL PRIMARY KEY,
  shop_id BIGINT NOT NULL,
  score NUMERIC,
  generated_at TIMESTAMP WITH TIME ZONE DEFAULT (now())
);

-- u0625u0646u0634u0627u0621 u0627u0644u0641u0647u0627u0631u0633 (u062au0645 u062du0630u0641 u0641u0647u0631u0633 GIST)
CREATE INDEX idx_shops_owner_id ON shops (owner_id);
CREATE INDEX idx_shops_renter_id ON shops (renter_id);
CREATE INDEX idx_images_shop_id ON images (shop_id);
CREATE INDEX idx_videos_shop_id ON videos (shop_id);
CREATE INDEX idx_features_shop_id ON features (shop_id);
CREATE INDEX idx_fav_shop_id ON favorites (shop_id);
CREATE INDEX idx_fav_entre_id ON favorites (entrepreneur_id);

-- u0625u0646u0634u0627u0621 u0627u0644u0639u0644u0627u0642u0627u062a
ALTER TABLE shops ADD FOREIGN KEY (owner_id) REFERENCES owners (id) ON DELETE CASCADE;
ALTER TABLE shops ADD FOREIGN KEY (renter_id) REFERENCES entrepreneurs (id);
ALTER TABLE images ADD FOREIGN KEY (shop_id) REFERENCES shops (shop_id) ON DELETE CASCADE;
ALTER TABLE videos ADD FOREIGN KEY (shop_id) REFERENCES shops (shop_id) ON DELETE CASCADE;
ALTER TABLE features ADD FOREIGN KEY (shop_id) REFERENCES shops (shop_id) ON DELETE CASCADE;
ALTER TABLE favorites ADD FOREIGN KEY (entrepreneur_id) REFERENCES entrepreneurs (id) ON DELETE CASCADE;
ALTER TABLE favorites ADD FOREIGN KEY (shop_id) REFERENCES shops (shop_id) ON DELETE CASCADE;
ALTER TABLE chats ADD FOREIGN KEY (entrepreneur_id) REFERENCES entrepreneurs (id) ON DELETE CASCADE;
ALTER TABLE chats ADD FOREIGN KEY (owner_id) REFERENCES owners (id) ON DELETE CASCADE;
ALTER TABLE ideas ADD FOREIGN KEY (entrepreneur_id) REFERENCES entrepreneurs (id) ON DELETE CASCADE;
ALTER TABLE ai_scores ADD FOREIGN KEY (shop_id) REFERENCES shops (shop_id) ON DELETE CASCADE;

-- u0625u0646u0634u0627u0621 u062cu062fu0648u0644 u0631u0645u0648u0632 u0627u0644u062au062du0642u0642
CREATE TABLE verification_codes (
  id SERIAL PRIMARY KEY,
  user_id UUID NOT NULL,
  phone VARCHAR(20) NOT NULL,
  code VARCHAR(6) NOT NULL,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  attempts INTEGER DEFAULT 0,
  verified BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
